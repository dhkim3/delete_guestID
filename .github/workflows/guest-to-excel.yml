name: Export Guest Users

on:
  workflow_dispatch:

jobs:
  guest-export:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Export Guest Users to Excel
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          # 모듈 설치
          Install-Module -Name ImportExcel -Force -Scope CurrentUser
          Install-Module -Name Microsoft.Graph -Force -Scope CurrentUser
          
          # PS1 스크립트 실행
          .\Get-GuestUsers.ps1

      - name: Commit Excel to repo
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "actions@github.com"
          git add GuestUsers_*.xlsx
          git commit -m "Update GuestUsers.xlsx" || echo "No changes"
          git push
