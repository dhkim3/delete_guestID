name: Export Guest Users

on:
  workflow_dispatch:  # 수동 실행 가능
  # schedule:        # 자동 스케줄 예시
  #   - cron: '0 9 * * *'  # 매일 오전 9시

jobs:
  guest-export:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup PowerShell
        uses: PowerShell/setup-powershell@v2
        with:
          pwsh-version: '7.3.6'

      - name: Export Guest Users to Excel
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          .\Get-GuestUsers.ps1

      - name: Commit Excel to repo
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "actions@github.com"
          git add GuestUsers_*.xlsx
          git commit -m "Update GuestUsers.xlsx" || echo "No changes"
          git push
